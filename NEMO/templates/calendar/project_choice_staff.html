<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal">&times;</button>
	<h4 class="modal-title">Which project is this for?</h4>
</div>

<div class="modal-body">
	{# Assume the dialog is cancelled by default, preventing the reservation request from being processed further. #}
	{# When a button is clicked this value is set to true, enabling further processing. #}
	{# Hiding the dialog using the X in the top right, or clicking outside of it, will stop processing. #}
	<input type="hidden" id="dialog_cancelled" value="true">
	<form id="additional_event_parameters" onsubmit="return false">
		<div class="radio"><label><input type="radio" onchange="show_self_ui()" name="staff_charge" value="self">Reserve this tool for my own project</label></div>

		<div id="self_ui" style="display: none;">
		<p>Associate your reservation with a project.</p>
		<input type="hidden" id="project_id" name="project_id">
		<select class="form-control" onchange="return set_project(this.options[this.selectedIndex].value);">
			<option value="">Please select a project</option>
		{% for project in active_projects %}
			<option value="{{ project.id }}">{{ project }}</option>
		{% endfor %}
		</select>
		</div>

		<div class="radio"><label><input type="radio" onchange="show_customer_ui()" name="staff_charge" value="customer">Reserve this tool on behalf of a customer.</label></div>

		{% for g in request.user.groups.all %}
		{% if g.name == "Fixed Cost Billing" %}
		<div class="checkbox" id="fixed_cost_toggle" style="display: none;"><label><input type="checkbox" onclick="show_customer_ui_fixed(this)" name="fixed_cost_check" id="fixed_cost_check" value="1" />Fixed per sample rate</label></div>
		{% endif %}
		{% endfor %}

		<div id="customer_ui" style="display: none;">
			<div id="project_choice_multi">
				<table id="customer_entries" class="table">
					<tr>
						<th>&nbsp;</th>
						<th style="min-width:200px">Customer</th>
						<th style="min-width:200px">Project</th>
					</tr>
					<tr>
						<td colspan="3" style="text-align:center"><a href="javascript:void(0)" onclick="add_customer()">Add another customer</a></td>
					</tr>
				</table>
			</div>

			<button id="done" class="btn btn-default" style="display:none">Done adding customers to this reservation</button>
		</div>

		<div id="customer_ui_fixed" style="display: none;">
			<div id="project_choice_multi_fixed">
				<table id="customer_entries_fixed" class="table">
					<tr>
						<th>&nbsp;</th>
						<th style="min-width:200px">Customer</th>
						<th style="min-width:200px">Project</th>
						<th style="min-width:200px">Cost Per Sample</th>
						<th style="min-width:200px"># of Samples</th>
						<th style="min-width:200px">Notes</th>
						<th style="min-width:100px">Process Status</th>
						<th style="min-width:200px">Transaction Group Members</th>
					</tr>
					<tr>
						<td colspan="8" style="text-align:center"><a href="javascript:void(0)" onclick="add_customer_fixed()">Add another customer</a></td>
					</tr>
				</table>
			</div>

			<button id="done_fixed" class="btn btn-default" style="display:none">Done adding customers to this reservation</button>
		</div>
	</form>
	<script type="text/javascript">
	{% load custom_tags_and_filters %}

	function set_project(id)
	{
		if (id == "") return false;
		$('#project_id').val(id);
		$('#dialog_cancelled').val(false);
		$('#dialog').modal('hide');
		return true;
	}

	var current_entry_number = 1;
	var is_fixed_cost = false;

	function show_self_ui()
	{
		for (i=1; i < current_entry_number; i++)
		{
			remove_row(i);
		}
		$("#fixed_cost_check").prop("checked",false);
		$("#fixed_cost_toggle").hide();
		$("#customer_ui_fixed").hide();
		$("#customer_ui").hide();
		$("#self_ui").show();
	}

	function show_customer_ui()
	{
		$("#self_ui").hide();
		$("#customer_ui").show();
		add_customer();
		$("#fixed_cost_toggle").show();
	}

	function show_customer_ui_fixed(el)
	{
		if (el.checked) {
			// show fixed cost interface
			is_fixed_cost = true;
			for (i=1; i < current_entry_number; i++)
			{
				remove_row(i);
			}
			$("#customer_ui").hide();
			$("#customer_ui_fixed").show();
			add_customer_fixed();
		} else {
			is_fixed_cost = false;
			for (i=1; i < current_entry_number; i++)
			{
				remove_row(i);
			}
			$("#customer_ui_fixed").hide();
			$("#customer_ui").show();
			add_customer();
		}
	}

	function add_transaction_group(row)
	{
		var checked = $("#transaction_group__" + row).prop("checked");
		var last = $("#row_" + row).children().last();
		if (checked) {
			// alert("Selected transaction group for row " + row);
			$(last).append("<input type='text' class='form-control' name='member_search__" + row + "' id='member_search__" + row + "' data-row=" + row + " />");
			$("#member_search__" + row).autocomplete('user', on_tg_member_selection, {{ staff_users|json_search_base }}).focus();
			$(last).append("<input type='hidden' name='transaction_group_member__"  + row +  "' id='transaction_group_member__"  + row +  "' value='0' />");
			$(last).append("<span style='display:inline-block; margin: 2px; padding: 2px;'><span class='glyphicon glyphicon-remove-circle grey pointer' onclick='delete_tg_member(" + row + ",{{ request.user.id }});$(this).parent().remove();'></span>{{ request.user }}</span>");
			add_tg_member(row,{{ request.user.id }});
		} else {
			// alert("De-selected transaction group for row " + row);
			$(last).html("");
		}
	}

	function  on_tg_member_selection(jquery_event, search_selection, dataset_name)
	{
		$(this).typeahead('val', search_selection.id);
		var row = $(this).data('row');
		$(this).parent().parent().append("<span style='display:inline-block; margin: 2px; padding: 2px;'><span class='glyphicon glyphicon-remove-circle grey pointer' onclick='delete_tg_member(" + row + "," + search_selection.id + ");$(this).parent().remove();'></span>" + search_selection.name + "</span>");
		add_tg_member(row,search_selection.id);
		$(this).val("").focus();
	}

	function add_tg_member(row, id)
	{
		var fieldname = "#transaction_group_member__" + row;
		var cur = $(fieldname).val();
		cur += "," + id;
		$(fieldname).val(cur);
	}

	function delete_tg_member(row, id)
	{
		var fieldname = "#transaction_group_member__" + row;
		var cur = $(fieldname).val();
		var id_arr = cur.split(",");
		var new_cur = "";
		id_arr.forEach(function(value) {
			if (value != id) {
				if (new_cur == "") {
					new_cur += value;
				} else {
					new_cur += "," + value;
				}
			}
		});
		$(fieldname).val(new_cur);
	}

	function add_customer()
	{
		var failure_dialog = ajax_failure_callback("Cannot add new entry", "The web browser was not able to communicate with the server.");
		ajax_get("{% url 'staff_charge_entry' %}", { "entry_number": current_entry_number }, add_entry_success_callback, failure_dialog);
		function add_entry_success_callback(response, status, xml_http_request)
		{
			$("#customer_entries tr:last").before(response);
			enable_autocompletion(current_entry_number);
			current_entry_number++;
		}
	}

	function add_customer_fixed()
	{
		var failure_dialog = ajax_failure_callback("Cannot add new entry", "The web browser was not able to communicate with the server.");
		ajax_get("{% url 'staff_charge_entry_fixed' %}", { "entry_number": current_entry_number }, add_entry_success_fixed_callback, failure_dialog);
		function add_entry_success_fixed_callback(response, status, xml_http_request)
		{
			$("#customer_entries_fixed tr:last").before(response);
			enable_autocompletion(current_entry_number);
			current_entry_number++;
		}
	}

	function enable_autocompletion(entry_number)
	{
		var id = "#user_textbox__" + entry_number;
		$(id).autocomplete('user', on_autocomplete_selection, {{ users|json_search_base }}).focus();
	}


	function remove_row(number)
	{
		$("#row_" + number).remove();
	}

	function on_autocomplete_selection(jquery_event, search_selection, dataset_name)
	{
		$(this).typeahead('val', search_selection.id).hide();
		var row = $(this).data('row');
		var button_id = "#" + dataset_name + "_button__" + row;
		$(button_id).val(search_selection.name).show();
		if(dataset_name == "user")
			fetch_projects(row, search_selection.id);
	}

	function fetch_projects(row, user_id)
	{
		var parameters =
		{
			"source_template": "staff_charges",
			"user_id": user_id,
			"entry_number": row
		};
		var target_element = "#project__" + row;
		var url = "{% url 'get_projects' %}?" + jQuery.param(parameters);
		var report_error = ajax_complete_callback("Could not fetch projects for user", "There was a problem obtaining the list of projects for the user.");
		$(target_element).load(url, undefined, function(responseTxt, statusTxt, xhr) {
			if (statusTxt == "success") {
				var el =  $("#chosen_project__" + row);

				if (el.tagName == "SELECT") {
					$("#chosen_project__" + row).change(function() {
						if (is_fixed_cost) {
							$("#done_fixed").click(on_submit);
							$("#done_fixed").show();
						} else {
							$("#done").click(on_submit);
							$("#done").show();
						}
					});
				} else {
					if (is_fixed_cost) {
						$("#done_fixed").click(on_submit);
						$("#done_fixed").show();
					} else {
						$("#done").click(on_submit);
						$("#done").show();
					}
				}
			} else {
				ajax_complete_callback("Could not fetch projects for user", "There was a problem obtaining the list of projects for the user.");
			}
		});
	}

	function purge_customer(row)
	{
		$("#user_button__" + row).hide();
		$("#project__" + row).html("");
		$("#user_textbox__" + row).typeahead('val', '').show().focus();
	}

	function on_submit()
	{
		var s;
		var o;
		var u;
		var b;
		var total_entry_count = 0;

		for (var i=0; i<=current_entry_number; i++) {
			b = false;
			s = "#user_textbox__" + i;

			if ($(s).length) {
				if ($(s).css("display") != "none") {
					alert("Please select a user for each row, or else delete the row.");
					$(s).focus();
					return false;
				} else {
					b = true;
				}
				total_entry_count++;
			}

			if (b) {
				s = "#chosen_project__" + i;
				if ($(s).prop("type") != "hidden") {
					o = $(s).find(":selected").val();
					if (o == "-1") {
						alert("Please select a value for each project field for each customer, or else delete the row.");
						$(s).focus();
						return false;
					}
				}
			}
		}

		if (total_entry_count == 0) {
			alert("You must add at least one customer in order to use this tool for other.");
			return false;
		}

		//var failure_dialog = ajax_failure_callback("Could not begin charging staff time");
		//var success_callbacks = [reload_page];
		//ajax_post("{% url 'create_reservation' %}", serialize("#additional_event_parameters"), success_callbacks, failure_dialog);
		$('#dialog_cancelled').val(false);
		$('#dialog').modal('hide');
		return true;
	}


	function on_load()
	{
		//add_customer();
		//add_customer_fixed();
	}

	$(on_load);
	</script>
</div>
