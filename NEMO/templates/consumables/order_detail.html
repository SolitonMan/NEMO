{% extends "base.html" %}
{% block content %}
<h2>Order {{ order.id }} by {{ order.user.get_full_name }}</h2>
<p>
	The details of this order are:<br />
	<b>Project:</b> {{ order.project }}<br />
	<b>Name:</b> {{ order.name }}<br />
	<b>Description:</b> {{ order.description }}
</p>
<p>The following items were included in this order:</p>
<table class="table table-striped">
{% for item in order.items.all %}
	<tr>
		<td>{{ item.quantity }} {{ item.consumable.unit.abbreviation }}</td>
		<td>{{ item.consumable.name }}</td>
		{% if not item.fulfilled and not item.cancelled %}
		<td><input type="button" onclick="mark_item_fulfilled({{ order.id }}, {{ item.id }});" value="Fulfill Item" class="btn btn-success" /></td>
		<td><input type="button" onclick="mark_item_cancelled({{ order.id }}, {{ item.id }});" value="Cancel Item" class="btn btn-danger" /></td>
		{% elif item.fulfilled %}
		<td colspan="2"><span class="text-success">Fulfilled</span></td>
		{% elif item.cancelled %}
		<td colspan="2"><span class="text-success">Cancelled</span></td>
		{% endif %}
	</tr>
{% endfor %}
</table>
<form method="post">
	{% csrf_token %}
	<input type="hidden" name="order_id" value="{{ order.id }}">
	<button type="submit" class="btn btn-success">Mark as Fulfilled</button>
</form>
<script>

	function mark_item_fulfilled(order_id, item_id) {
		$.ajax({
			url: "{% url 'mark_item_fulfilled' 0 1 %}".replace("0", item_id),
			type: "POST",
			data: {
				order_id: order_id,
				item_id: item_id,
				csrfmiddlewaretoken: '{{ csrf_token }}'
			},
			success: function (response) {
				location.reload();
			}
		});
	}

	function mark_item_cancelled(order_id, item_id) {
		let cancel_msg = prompt("Please enter a reason for cancelling this item:");
		if (cancel_msg == null || cancel_msg == "") {
			alert("You must enter a reason to cancel this item.");
			return;
		}
		$.ajax({
			url: "{% url 'mark_item_cancelled' 0 %}".replace("0", item_id),
			type: "POST",
			data: {
				order_id: order_id,
				item_id: item_id,
				cancel_msg: cancel_msg,
				csrfmiddlewaretoken: '{{ csrf_token }}'
			},
			success: function (response) {
				location.reload();
			}
		});
	}
</script>
{% endblock %}
