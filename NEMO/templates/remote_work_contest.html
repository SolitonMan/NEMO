{% extends 'base.html' %}
{% load custom_tags_and_filters %}

{% block extrahead %}
	{% load static %}
	<script type="text/javascript" src="{% static "datetimepicker/bootstrap-datetimepicker.js" %}"></script>
	<link rel="stylesheet" type="text/css" href="{% static "datetimepicker/bootstrap-datetimepicker.css" %}"/>
{% endblock %}

{% block title %}Contest {{ contest_type }}{% endblock %}

{% block content %}
	<h1>Contest {{ contest_type }}</h1>

	<p>You have selected the {{ contest_type }} detailed below to contest.  Please update the relevant fields to indicate what the corrected values for this transaction should be, then select a general reason this item should be contested and enter a description of the specifics.  If you're requesting this transaction not be charged, select the checkbox and choose the reason and enter a description - no other changes are necessary in that case.  Once this form is submitted the {{ contest_type }} will be placed in contested status until an administrator can review the record and address it as needed.</p>

	<form name="contest" id="contest" action="{% url 'save_contest' %}" method="POST" onsubmit="return on_submit();">
	{% csrf_token %}
	<input type="hidden" name="contest_type" value="{{ contest_type }}" />
	<p style="border: 2px solid black; padding: 5px; background-color: #f2dede;">
		<input type="checkbox" name="no_charge_flag" id="no_charge_flag" onclick="set_no_charge_form();" style="margin: 8px;" /><b>No charge for this transaction</b> (This option will disable all of the fields except for Contest Reason and Contest Description, which are required.  No other changes are necessary if the sole purpose of the contest is to not charge for this transaction)
	</p>
	<br/>

	{% if usage_event is not None %}
	<input type="hidden" name="usage_event_id" value="{{ usage_event.id }}" />
	<table class="table">
		<tr>
			<th>Tool</th>
			<td>
				{{ usage_event.tool.name }}
				<input type="hidden" name="original__tool_id__{{ usage_event.id }}" value="{{ usage_event.tool.id }}" />
				<input type="hidden" name="proposed__tool_id__{{ usage_event.id }}" value="{{ usage_event.tool.id }}" />
			</td>
		</tr>
		<tr>
			<th>Start</th>
			<td>
				<div class="datetimepicker-container">
					<input type="text" class="form-control" name="proposed__start__{{ usage_event.id }}" id="proposed__start__{{ usage_event.id }}" value="{{ usage_event.start|date:'Y-m-d H:i:s' }}" />
				</div>
				<input type="hidden" id="original__start__{{ usage_event.id }}" name="original__start__{{ usage_event.id }}" value="{{ usage_event.start|date:'Y-m-d H:i:s' }}" />
			</td>
		</tr>
		<tr>
			<th>End</th>
			<td>
				<div class="datetimepicker-container">
					<input type="text" class="form-control" name="proposed__end__{{ usage_event.id }}" id="proposed__end__{{ usage_event.id }}" value="{{ usage_event.end|date:'Y-m-d H:i:s' }}" />
				</div>
				<input type="hidden" id="original__end__{{ usage_event.id }}" name="original__end__{{ usage_event.id }}" value="{{ usage_event.end|date:'Y-m-d H:i:s' }}" />
			</td>
		</tr>
		<tr>
			<th>Operator</th>
			<td>{{ usage_event.operator }}</td>
		</tr>
		<tr>
			<td colspan="2">
				<table class="table" id="customer_project_entries">
					<thead>
					<tr>
						<th>Delete</th>
						<th>Customer</th>
						<th>Project</th>
						{% if usage_event.cost_per_sample_run %}
						<th>Cost Per Sample</th>
						<th>No. Samples</th>
						{% else %}
						<th>Percent</th>
						{% endif %}
					</tr>
					</thead>
					<tbody>
					{% for u in uep %}
					<tr id="row_{{ u.id }}">
						<td>
							<input type="checkbox" name="delete_customer__{{ u.id }}" id="delete_customer__{{ u.id }}" value="1" onclick="mark_for_delete({{ u.id }});" {% if not request.user.is_superuser and not request.user.is_staff %}disabled{% endif %}/>
							<input type="hidden" id="original__chosen_project__{{ u.id }}" name="original__chosen_project__{{ u.id }}" value="{{ u.project.id }}" />
						</td>
						<td>
							<input type="hidden" value="{{ u.customer.id }}" name="original__chosen_user__{{ u.id }}" id="original__chosen_user__{{ u.id }}" />
							{% if request.user.is_superuser or request.user.is_staff %}
							<input type="button" class="btn btn-default" value="{{ u.customer }}" name="button__chosen_user__{{ u.id }}" id="button__chosen_user__{{ u.id }}" onclick="change_customer({{ u.id }});" />
							<input type="text" class="form-control" id="proposed__chosen_user__{{ u.id }}" name="proposed__chosen_user__{{ u.id }}" value="{{ u.customer.id }}" data-row="{{ u.id }}" style="display: none;" />
							{% else %}
							<input type="hidden" id="proposed__chosen_user__{{ u.id }}" name="proposed__chosen_user__{{ u.id }}" value="{{ u.customer.id }}" data-row="{{ u.id }}" />
							{{ u.customer }}
							{% endif %}
						</td>
						<td id="user_project__{{ u.id }}">
							{% if u.customer.active_project_count == 1 %}
								{{ u.project }}
								<input type="hidden" id="proposed__chosen_project__{{ u.id }}" name="proposed__chosen_project__{{ u.id }}" value="{{ u.project.id }}" />
							{% else %}
							<select name="proposed__chosen_project__{{ u.id }}" id="proposed__chosen_project__{{ u.id }}" class="form-control">
								{% for p in u.customer.all_projects.all %}
								<option value="{{ p.id }}"{% if p == u.project %} selected{% endif %}>{{ p }} [{{ p }}]</option>
								{% endfor %}
							</select>
							{% endif %}
						</td>
						{% if usage_event.cost_per_sample_run %}
						<td>
							<input type="text" class="form-control" name="proposed__cost_per_sample__{{ u.id }}" id="proposed__cost_per_sample__{{ u.id }}" value="{{ u.cost_per_sample }}" />
							<input type="hidden" id="original__cost_per_sample__{{ u.id }}" name="original__cost_per_sample__{{ u.id }}" value="{{ u.cost_per_sample }}" />
						</td>
						<td>
							<input type="text" class="form-control" name="proposed__sample_num__{{ u.id }}" id="proposed__sample_num__{{ u.id }}" value="{{ u.sample_num }}" />
							<input type="hidden" id="original__sample_num__{{ u.id }}" name="original__sample_num__{{ u.id }}" value="{{ u.sample_num }}" />
						</td>
						{% else %}
						<td>
							<input type="text" class="form-control" name="proposed__project_percent__{{ u.id }}" id="proposed__project_percent__{{ u.id }}" value="{{ u.project_percent }}" />
							<input type="hidden" id="original__project_percent__{{ u.id }}" name="original__project_percent__{{ u.id }}" value="{{ u.project_percent }}" />
						</td>
						{% endif %}
					</tr>	
					{% endfor %}
					{% if request.user.is_superuser or request.user.is_staff %}
					<tr>
						<td {% if usage_event.cost_per_sample_run %}colspan="5"{% else %}colspan="4"{% endif %} style="text-align:center"><a href="javascript:void(0)" id="add_customer_link">Add another customer</a></td>
					</tr>
					{% endif %}
					</tbody>
				</table>
			</td>
		</tr>
	</table>
	<script type="text/javascript">
	$("#proposed__start__{{ usage_event.id }}").datetimepicker({format: 'YYYY-MM-DD hh:mm A'});
	$("#proposed__end__{{ usage_event.id }}").datetimepicker({format: 'YYYY-MM-DD hh:mm A'});
	</script>
	{% endif %}

	{% if staff_charge is not None %}
	<input type="hidden" name="staff_charge_id" value="{{ staff_charge.id }}" />
	<table class="table">
		<tr>
			<th>Staff Member</th>
			<td>{{ staff_charge.staff_member }}</td>
		</tr>
		<tr>
			<th>Start</th>
			<td>
				<div class="datetimepicker-container">
					<input type="text" class="form-control" name="proposed__start__{{ staff_charge.id }}" id="proposed__start__{{ staff_charge.id }}" value="{{ staff_charge.start|date:'Y-m-d H:i:s' }}" />
				</div>
				<input type="hidden" id="original__start__{{ staff_charge.id }}" name="original__start__{{ staff_charge.id }}" value="{{ staff_charge.start|date:'Y-m-d H:i:s' }}" />
			</td>
		</tr>
		<tr>
			<th>End</th>
			<td>
				<div class="datetimepicker-container">
					<input type="text" class="form-control" name="proposed__end__{{ staff_charge.id }}" id="proposed__end__{{ staff_charge.id }}" value="{{ staff_charge.end|date:'Y-m-d H:i:s' }}" />
				</div>
				<input type="hidden" id="original__end__{{ staff_charge.id }}" name="original__end__{{ staff_charge.id }}" value="{{ staff_charge.end|date:'Y-m-d H:i:s' }}" />
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<table class="table" id="customer_project_entries">
					<thead>
					<tr>
						<th>Delete</th>
						<th>Customer</th>
						<th>Project</th>
						<th>Percent</th>
					</tr>
					</thead>
					<tbody>
					{% for s in scp %}
					<tr id="row_{{ s.id }}">
						<td>
							<input type="checkbox" name="delete_customer__{{ s.id }}" id="delete_customer__{{ s.id }}" value="1" onclick="mark_for_delete({{ s.id }});" />
							<input type="hidden" id="original__chosen_project__{{ s.id }}" name="original__chosen_project__{{ s.id }}" value="{{ s.project.id }}" />
						</td>
						<td>
							<input type="button" class="btn btn-default" value="{{ s.customer }}" name="button__chosen_user__{{ s.id }}" id="button__chosen_user__{{ s.id }}" onclick="change_customer({{ s.id }});" />
							<input type="hidden" value="{{ s.customer.id }}" name="original__chosen_user__{{ s.id }}" id="original__chosen_user__{{ s.id }}" />
							<input type="text" class="form-control" id="proposed__chosen_user__{{ s.id }}" name="proposed__chosen_user__{{ s.id }}" value="{{ s.customer.id }}" data-row="{{ s.id }}" style="display: none;" />
						</td>
						<td id="user_project__{{ s.id }}">
							{% if s.customer.active_project_count == 1 %}
								{{ s.project }}
								<input type="hidden" id="proposed__chosen_project__{{ s.id }}" name="proposed__chosen_project__{{ s.id }}" value="{{ s.project.id }}" />
							{% else %}
							<select name="proposed__chosen_project__{{ s.id }}" id="proposed__chosen_project__{{ s.id }}" class="form-control">
								{% for p in s.customer.all_projects.all %}
								<option value="{{ p.id }}"{% if p == s.project %} selected{% endif %}>{{ p }} [{{ p }}]</option>
								{% endfor %}
							</select>
							{% endif %}
						</td>
						<td>
							<input type="text" class="form-control" name="proposed__project_percent__{{ s.id }}" id="proposed__project_percent__{{ s.id }}" value="{{ s.project_percent }}" />
							<input type="hidden" id="original__project_percent__{{ s.id }}" name="original__project_percent__{{ s.id }}" value="{{ s.project_percent }}" />
						</td>
					</tr>
					{% endfor %}
					<tr>
						<td colspan="4" style="text-align:center"><a href="javascript:void(0)" id="add_customer_link">Add another customer</a></td>
					</tr>
					</tbody>
				</table>
			</td>
		</tr>
	</table>
        <script type="text/javascript">
        $("#proposed__start__{{ staff_charge.id }}").datetimepicker({format: 'YYYY-MM-DD hh:mm A'});
        $("#proposed__end__{{ staff_charge.id }}").datetimepicker({format: 'YYYY-MM-DD hh:mm A'});
        </script>
	{% endif %}

	{% if area_access_record is not None %}
	<input type="hidden" name="area_access_record_id" value="{{ area_access_record.id }}" />
	<table class="table">
		<tr>
			<th>Area</th>
			<td>
				<select name="proposed__area__{{ area_access_record.id }}" id="proposed__area__{{ area_access_record.id }}" class="form-control">
				{% for a in areas %}
					<option value="{{ a.id }}" {% if a == area_access_record.area %}selected{% endif %}>{{ a }}</option>
				{% endfor %}
				</select>
				<input type="hidden" name="original__area__{{ area_access_record.id }}" id="original__area__{{ area_access_record.id }}" value="{{ area_access_record.area.id }}" />
			</td>
		</tr>
		<tr>
			<th>Staff Member</th>
			<td>{% if area_access_record.staff_charge %}{{ area_access_record.staff_charge.staff_member }}{% endif %}</td>
		</tr>
		<tr>
			<td colspan="2">
				<table class="table" id="customer_project_entries">
					<thead>
					<tr>
						<th>Delete</th>
						<th>Customer</th>
						<th>Project</th>
						<th>Percent</th>
					</tr>
					</thead>
					<tbody>
					{% for a in aarp %}
					<tr id="row_{{ a.id }}">
						<td>
							<input type="checkbox" name="delete_customer__{{ a.id }}" id="delete_customer__{{ a.id }}" value="1" onclick="mark_for_delete({{ a.id }});" {% if not request.user.is_superuser and not request.user.is_staff %}disabled{% endif %}/>
							<input type="hidden" id="original__chosen_project__{{ a.id }}" name="original__chosen_project__{{ a.id }}" value="{{ a.project.id }}" />
						</td>
						<td>
							<input type="hidden" value="{{ a.customer.id }}" name="original__chosen_user__{{ a.id }}" id="original__chosen_user__{{ a.id }}" />
							{% if request.user.is_superuser or request.user.is_staff %}
							<input type="button" class="btn btn-default" value="{{ a.customer }}" name="button__chosen_user__{{ a.id }}" id="button__chosen_user__{{ a.id }}" onclick="change_customer({{ a.id }});" />
							<input type="text" class="form-control" id="proposed__chosen_user__{{ a.id }}" name="proposed__chosen_user__{{ a.id }}" value="{{ a.customer.id }}" data-row="{{ a.id }}" style="display: none;" />
							{% else %}
							<input type="hidden" id="proposed__chosen_user__{{ a.id }}" name="proposed__chosen_user__{{ a.id }}" value="{{ a.customer.id }}" data-row="{{ a.id }}" />
							{{ a.customer }}
							{% endif %}
						</td>
						<td id="user_project__{{ a.id }}">
							{% if a.customer.active_project_count == 1 %}
								{{ a.project }}
								<input type="hidden" id="proposed__chosen_project__{{ a.id }}" name="proposed__chosen_project__{{ a.id }}" value="{{ a.project.id }}" />
							{% else %}
							<select name="proposed__chosen_project__{{ a.id }}" id="proposed__chosen_project__{{ a.id }}" class="form-control">
								{% for p in a.customer.all_projects.all %}
								<option value="{{ p.id }}"{% if p == a.project %} selected{% endif %}>{{ p }} [{{ p }}]</option>
								{% endfor %}
							</select>
							{% endif %}
						</td>
						<td>
							<input type="text" class="form-control" name="proposed__project_percent__{{ a.id }}" id="proposed__project_percent__{{ a.id }}" value="{{ a.project_percent }}" />
							<input type="hidden" id="original__project_percent__{{ a.id }}" name="original__project_percent__{{ a.id }}" value="{{ a.project_percent }}" />
						</td>
					</tr>
					{% endfor %}
					<tr>
						<td colspan="4" style="text-align:center"><a href="javascript:void(0)" id="add_customer_link">Add another customer</a></td>
					</tr>
					</tbody>
				</table>
			</td>
		</tr>
		<tr>
			<th>Start</th>
			<td>
				<div class="datetimepicker-container">
					<input type="text" class="form-control" name="proposed__start__{{ area_access_record.id }}" id="proposed__start__{{ area_access_record.id }}" value="{{ area_access_record.start|date:'Y-m-d H:i:s' }}" />
				</div>
				<input type="hidden" id="original__start__{{ area_access_record.id }}" name="original__start__{{ area_access_record.id }}" value="{{ area_access_record.start|date:'Y-m-d H:i:s' }}" />
			</td>
		</tr>
		<tr>
			<th>End</th>
			<td>
				<div class="datetimepicker-container">
					<input type="text" class="form-control" name="proposed__end__{{ area_access_record.id }}" id="proposed__end__{{ area_access_record.id }}" value="{{ area_access_record.end|date:'Y-m-d H:i:s' }}" />
				</div>
				<input type="hidden" id="original__end__{{ area_access_record.id }}" name="original__end__{{ area_access_record.id }}" value="{{ area_access_record.end|date:'Y-m-d H:i:s' }}" />
			</td>
		</tr>
		<tr>
			<th>Duration</th>
			<td>{{ area_access_record.duration|smooth_timedelta }}</td>
		</tr>
	</table>
	<script type="text/javascript">
	$("#proposed__start__{{ area_access_record.id }}").datetimepicker({format: 'YYYY-MM-DD hh:mm A'});
	$("#proposed__end__{{ area_access_record.id }}").datetimepicker({format: 'YYYY-MM-DD hh:mm A'});
	</script>
	{% endif %}

	{% if consumable_withdraw is not None %}
	<input type="hidden" name="consumable_withdraw_id" value="{{ consumable_withdraw.id }}" />
	<table class="table">
		<tr>
			<th>Consumable</th>
			<td>
				<select name="proposed__consumable__{{ consumable_withdraw.id }}" id="proposed__consumable__{{ consumable_withdraw.id }}" class="form-control">
				{% for c in consumables %}
					<option value="{{ c.id }}" {% if c == consumable_withdraw.consumable %}selected{% endif %}>{{ c.name }}</option>
				{% endfor %}
				</select>
				<input type="hidden" name="original__consumable__{{ consumable_withdraw.id }}" id="original__consumable__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.consumable.id }}" />
			</td>
		</tr>
		<tr>
			<th>Quantity</th>
			<td>
				<input type="text" class="form-control" value="{{ consumable_withdraw.quantity }}" name="proposed__quantity__{{ consumable_withdraw.id }}" id="proposed__quantity__{{ consumable_withdraw.id }}" /> {% if consumable_withdraw.consumable.unit is not None %}{{ consumable_withdraw.consumable.unit }}{% endif %}
				<input type="hidden" value="{{ consumable_withdraw.quantity }}" name="original__quantity__{{ consumable_withdraw.id }}" id="original__quantity__{{ consumable_withdraw.id }}" />
			</td>
		</tr>
		<tr>
			<th>Staff member</th>
			<td>{{ consumable_withdraw.merchant }}</td>
		</tr>
		<tr>
			<th>Customer</th>
			<td>
				<input type="hidden" value="{{ consumable_withdraw.customer.id }}" name="original__chosen_user__{{ consumable_withdraw.id }}" id="original__chosen_user__{{ consumable_withdraw.id }}" />
				<input type="hidden" id="original__chosen_project__{{ consumable_withdraw.id }}" name="original__chosen_project__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.project.id }}" />
				{% if request.user.is_superuser or request.user.is_staff %}
				<input type="button" class="btn btn-default" value="{{ consumable_withdraw.customer }}" name="button__chosen_user__{{ consumable_withdraw.id }}" id="button__chosen_user__{{ consumable_withdraw.id }}" onclick="change_customer({{ consumable_withdraw.id }});" />
				<input type="text" class="form-control" id="proposed__chosen_user__{{ consumable_withdraw.id }}" name="proposed__chosen_user__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.customer.id }}" data-row="{{ consumable_withdraw.id }}" style="display: none;" />
				{% else %}
				<input type="hidden" id="proposed__chosen_user__{{ consumable_withdraw.id }}" name="proposed__chosen_user__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.customer.id }}" data-row="{{ consumable_withdraw.id }}" />
				{{ consumable_withdraw.customer }}
				{% endif %}
			</td>
		</tr>
		<tr>
			<th>Project</th>
			<td id="user_project__{{ consumable_withdraw.id }}">
				{% if consumable_withdraw.customer.active_project_count == 1 %}
					{{ consumable_withdraw.project }}
					<input type="hidden" id="proposed__chosen_project__{{ consumable_withdraw.id }}" name="proposed__chosen_project__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.project.id }}" />
				{% else %}
					<select name="proposed__chosen_project__{{ consumable_withdraw.id }}" id="proposed__chosen_project__{{ consumable_withdraw.id }}" class="form-control">
						{% for p in consumable_withdraw.customer.all_projects.all %}
						<option value="{{ p.id }}"{% if p == consumable_withdraw.project %} selected{% endif %}>{{ p }}</option>
						{% endfor %}
					</select>
				{% endif %}
			</td>
		</tr>
		<tr>
			<th>Percent</th>
			<td>
				<input type="hidden" id="original__project_percent__{{ consumable_withdraw.id }}" name="original__project_percent__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.project_percent }}" />
				<input type="text" class="form-control" id="proposed__project_percent__{{ consumable_withdraw.id }}" name="proposed__project_percent__{{ consumable_withdraw.id }}" value="{{ consumable_withdraw.project_percent }}" />
			</td>
		</tr>
		<tr>
			<th>Withdraw date</th>
			<td>{{ consumable_withdraw.date }}</td>
		</tr>
	</table>
	{% endif %}

	<table class="table">
		<tr>
			<td>
				<label for="contest_reason">Contest Reason
				<select class="form-control" name="contest_reason" id="contest_reason">
					<option value="">Please select a contest reason</option>
					<option value="Equipment error">Equipment error</option>
					<option value="Sample rework">Sample rework</option>
					<option value="Forgot to log out">Forgot to log out</option>
					<option value="Erroneous percentage assignments">Erroneous percentage assignments</option>
					<option value="Incorrect project selection">Incorrect project selection</option>
					<option value="Time adjustment">Time adjustment</option>
					<option value="Wrong customer">Wrong customer</option>
					<option value="Other">Other</option>
				</select>
				</label>
				<input class="form-control" type="text" value="" placeholder="Enter an other reason for contest" name="other_reason" id="other_reason" />
			</td>
		</tr>
		<tr>
			<td>
				<label for="contest_description">Contest Description
				<textarea class="form-control" rows="10" cols="100" name="contest_description" id="contest_description"></textarea>
				</label>
			</td>
		</tr>
		<tr>
			<td>
				<input type="submit" class="btn btn-default" value="Contest {{ contest_type }}" />
				<input type="button" class="btn btn-danger" value="Cancel" onclick="window.location.href='{% url 'remote_work' %}';" />
			</td>
		</tr>
	</table>
	</form>

	<script type="text/javascript">
	var current_entry_number = 0;
	function set_other(sel)
	{
		option = sel.options[sel.selectedIndex].value;
		if (option == "Other") {
			$("#other_reason").show();
		} else {
			$("#other_reason").hide();
		}
	}
	function mark_for_delete(eid)
	{
		var s = "#delete_customer__" + eid;

		// check for a new entry, which can just be deleted
		var seid = String(eid);
		var nc = seid.substring(0, 8);

		if (nc == "newentry") {
			var row = "#row_" + seid;
			$(row).remove();
			return;
		}

		if ($(s).is(":checked")) {
			// disable inputs
			s = "#row_" + eid + " input";
			$(s).each(function() {
				if ($(this).prop("type") != "checkbox") {
					$(this).prop("disabled", true);
				}
			});
			s = "#row_" + eid + " select";
			$(s).each(function() {
				$(this).prop("disabled", true);
			});

			// remove values
			s = "input[name*='proposed__project_percent__']";
			$(s).each(function() {
				$(this).val("");
			});
		} else {
			// re-enable inputs
			s = "#row_" + eid + " input";
			$(s).each(function() {
				$(this).prop("disabled", false);
			});
			s = "#row_" + eid + " select";
			$(s).each(function() {
				$(this).prop("disabled", false);
			});

			/* replace project percent values if no items are marked for delete
			if (!$("input[name*='delete_customer__']").is(":checked")) {
				s = "input[name*='proposed__project_percent__']";
				$(s).each(function() {
					iid = $(this).prop("name").split("__")[2];
					original_val = "#original__project_percent__" + iid;
					$(this).val($(original_val).val());
				});
			}
			*/
			// remove values
			s = "input[name*='proposed__project_percent__']";
			$(s).each(function() {
				$(this).val("");
			});
		}
	}
	function set_no_charge_form()
	{
		if ($("#no_charge_flag").is(":checked")) {
			$("input").each(function() {
				if ($(this).prop("name") != "no_charge_flag" && $(this).prop("name") != "other_reason") {
					if ($(this).prop("type") != "hidden" && $(this).prop("type") != "submit") {
						$(this).prop("disabled", true);
						if ($(this).prop("type") == "checkbox") {
							$(this).prop("checked", false);
						}
					}
				}
			});

			$("select").each(function() {
				if ($(this).prop("name") != "contest_reason") { 
					$(this).prop("disabled", true);
				}
			});

			$("#add_customer_link").unbind("click");
		} else {
			$("input").each(function() {
				if ($(this).prop("name") != "no_charge_flag" && $(this).prop("name") != "other_reason") {
					if (!($(this).prop("type") == "hidden" && $(this).prop("type") != "submit")) {
						{% if request.user.is_superuser or request.user.is_staff %}
						$(this).prop("disabled", false);
						{% else %}
						if ($(this).prop("type") != "checkbox") {
							$(this).prop("disabled", false);
						}
						{% endif %}
					}
				}
			});

			$("select").each(function() {
				if ($(this).prop("name") != "contest_reason") {
					$(this).prop("disabled", false);
				}
			});

			$("#add_customer_link").bind("click", add_customer);
		}
	}
	function on_submit()
	{
		$("input[type='submit']").prop("disabled",true);

		var bSubmit = true;
		var bChanged = false;
		var bContinue = true;
		var error_message = "";

		if ($("#no_charge_flag").is(":checked")) {
			bChanged = true;
		}

		if ($("#contest_reason").val() == "") {
			error_message = "Please select a reason for contesting this {{ contest_type }}.";
			$("#contest_reason").focus();
			bSubmit = false;
			bContinue = false;
			bChanged = true;
		}
		if (bContinue) {
			if ($("#contest_description").val() == "") {
				error_message = "Please enter a contest description.";
				$("#contest_description").focus();
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}


		{% if usage_event is not None or staff_charge is not None or area_access_record is not None %}

		{% if usage_event is not None %}
		var prop_start = $("#proposed__start__{{ usage_event.id }}");
		var prop_end = $("#proposed__end__{{ usage_event.id }}");
		var orig_start = $("#original__start__{{ usage_event.id }}");
		var orig_end = $("#original__end__{{ usage_event.id }}");
		{% endif %}

		{% if staff_charge is not None %}
		var prop_start = $("#proposed__start__{{ staff_charge.id }}");
		var prop_end = $("#proposed__end__{{ staff_charge.id }}");
		var orig_start = $("#original__start__{{ staff_charge.id }}");
		var orig_end = $("#original__end__{{ staff_charge.id }}");
		{% endif %}

		{% if area_access_record is not None %}
		var prop_start = $("#proposed__start__{{ area_access_record.id }}");
		var prop_end = $("#proposed__end__{{ area_access_record.id }}");
		var orig_start = $("#original__start__{{ area_access_record.id }}");
		var orig_end = $("#original__end__{{ area_access_record.id }}");
		{% endif %}

		if (bContinue) {
			if (prop_start.val() == "") {
				error_message = "The start date may not be blank";
				prop_start.focus();
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			} else {
				prop_start.val(convert_12_to_24(prop_start.val()));
			}
		}

		if (bContinue) {
			if (prop_end.val() == "") {
				error_message = "The end date may not be blank";
				prop_end.focus();
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			} else {
				prop_end.val(convert_12_to_24(prop_end.val()));
			}
		}

		var prop_start_date = new Date(prop_start.val());
		var prop_end_date = new Date(prop_end.val());

		if (bContinue) {
			if (prop_end_date <= prop_start_date) {
				error_message = "The end date must be after the start date.  Please adjust your dates to correct this.";
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		if (bContinue) {
			if (prop_start.val() != orig_start.val() || prop_end.val() != orig_end.val()) {
				bChanged = true;
			}
		}

		$("input[name*='proposed__chosen_user__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "") {
							error_message = "Please select a user for each entry";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							s = "#original__chosen_user__" + $(element).prop("name").split("__")[2];
							if ($(s).val() != $(element).val()) {
								bChanged = true;
							}
						}
					}
				}
			}
		);

		if (bContinue) {
			if ($("input[name*='proposed__chosen_user__']").length == 0) {
				error_message = "There must be at least one customer.  Please adjust your submission, or cancel and restart if that would be easier.";
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		$("select[name*='proposed__chosen_project__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "" || $(element).val() == "-1") {
							error_message = "Please select a project for each entry";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							s = "#original__chosen_project__" + $(element).prop("name").split("__")[2];

							if ($(element).children("option")) {
								if ($(s).val() != $(element).children("option:selected").val()) {
									bChanged = true;
								}
							} else {
								if ($(s).val() != $(element).val()) {
									bChanged = true;
								}
							}
						}
					}
				}
			}
		);

		if (bContinue) {
			if ($("select[name*='proposed__chosen_project__']").length == 0 && $("input[name*='proposed__chosen_project__']").length == 0) {
				error_message = "There must be at least one project selected for this transaction.  Please adjust your submission, or cancel and restart if that would be easier.";
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		{% if usage_event is not None and usage_event.cost_per_sample_run %}
		$("input[name*='proposed__sample_num__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if ($(element).val() == "" || isNaN(parseInt($(element).val()))) {
						error_message = "Please enter an integer value for each number of samples field";
						$(element).focus();
						bSubmit = false;
						bContinue = false;
						bChanged = true;
					} else {
						s = "#original__sample_num__" + $(element).prop("name").split("__")[2];
						if ($(s).val() != $(element).val()) {
							bChanged = true;
						}
					}
				}
			}
		);
		$("input[name*='proposed__cost_per_sample__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if ($(element).val() == "" || isNaN(parseFloat($(element).val()))) {
						error_message = "Please enter a numerical value for each cost per sample field";
						$(element).focus();
						bSubmit = false;
						bContinue = false;
						bChanged = true;
					} else {
						s = "#original__cost_per_sample__" + $(element).prop("name").split("__")[2];
						if ($(s).val() != $(element).val()) {
							bChanged = true;
						}
					}
				}
			}
		);
		{% else %}
		var percent = 0.0;

		$("input[name*='proposed__project_percent__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "" || isNaN(parseFloat($(element).val()))) {
							error_message = "Please enter a numerical value for each project percent field";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							percent += parseFloat($(element).val());

							s = "#original__project_percent__" + $(element).prop("name").split("__")[2];
							if ($(s).val() != $(element).val()) {
								bChanged = true;
							}
						}
					}
				}
			}
		);

		if (bContinue) {
			if (!$("#no_charge_flag").is(":checked")) {
				if (parseInt(percent) != 100) {
					error_message = "Percent totals must equal 100";
					bSubmit = false;
					bContinue = false;
					bChanged = true;
				}
			}
		}
		{% endif %}

		
		{% endif %}

		{% if area_access_record is not None %}
		$("select[name*='proposed__area__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "-1" || $(element).val() == "") {
							error_message = "Please select an area to assign to this transaction.";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							s = "#original__area__" + $(element).prop("name").split("__")[2];
							if ($(s).val() != $(element).val()) {
								bChanged = true;
							}
						}
					}
				}
			}
		);
		{% endif %}

		{% if consumable_withdraw is not None %}
		var quantity = $("#proposed__quantity__{{ consumable_withdraw.id }}");
		var orig_quantity = $("#original__quantity__{{ consumable_withdraw.id }}");

		if (bContinue) {
			if (quantity.val() == "") {
				error_message = "The quantity cannot be blank.  Please enter a numerical value.";
				quantity.focus();
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		if (bContinue) {
			if (isNaN(parseInt(quantity.val())) && isNaN(parseFloat(quantity.val()))) {
				error_message = "Please enter only a numerical value for the quantity.";
				quantity.focus();
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		if (bContinue) {
			if (quantity.val() != orig_quantity.val()) {
				bChanged = true;
			}
		}

		$("input[name*='proposed__chosen_user__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "") {
							error_message = "Please select a user for each entry";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							s = "#original__chosen_user__" + $(element).prop("name").split("__")[2];

							if ($(s).val() != $(element).val()) {
								bChanged = true;
							}
						}
					}
				}
			}
		);

		if (bContinue) {
			if ($("input[name*='proposed__chosen_user__']").length == 0) {
				error_message = "There must be at least one customer.  Please adjust your submission, or cancel and restart if that would be easier.";
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		$("select[name*='proposed__chosen_project__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "" || $(element).val() == "-1") {
							error_message = "Please select a project for each entry";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							s = "#original__chosen_project__" + $(element).prop("name").split("__")[2];

							if ($(element).children("option")) {
								if ($(s).val() != $(element).children("option:selected").val()) {
									bChanged = true;
								}
							} else {
								if ($(s).val() != $(element).val()) {
									bChanged = true;
								}
							}
						}
					}
				}
			}
		);

		if (bContinue) {
			if ($("select[name*='proposed__chosen_project__']").length == 0 && $("input[name*='proposed__chosen_project__']").length == 0) {
				error_message = "There must be at least one project chosen for this transaction.  Please adjust your submission, or cancel and restart if that would be easier.";
				bSubmit = false;
				bContinue = false;
				bChanged = true;
			}
		}

		var percent = 0.0;

		$("input[name*='proposed__project_percent__']").each(
			function(index, element) {
				if (!$(element).prop("disabled")) {
					if (bContinue) {
						if ($(element).val() == "" || isNaN(parseFloat($(element).val()))) {
							error_message = "Please enter a numerical value for each project percent field";
							$(element).focus();
							bSubmit = false;
							bContinue = false;
							bChanged = true;
						} else {
							percent += parseFloat($(element).val());

							s = "#original__project_percent__" + $(element).prop("name").split("__")[2];

							if ($(s).val() != $(element).val()) {
								bChanged = true;
							}
						}
					}
				}
			}
		);

		{% endif %}

		if (!bChanged) {
			error_message = "No changes were detected in your contest, and it's not selected as a no charge request.  Please update the field values appropriately and submit your request again.  If you're not sure how to make the needed change please contact LEOHelp@psu.edu.";
			bSubmit = false;
		}

		if (!bSubmit) {
			$("input[type='submit']").prop("disabled", false);
			alert(error_message);
		}

		return bSubmit;
	}
	function change_customer(i)
	{
		
		// update textbox
		var selector = "#proposed__chosen_user__" + i;
		$(selector).val("");
		$(selector).show();
		// hide button
		selector = "#button__chosen_user__" + i;
		$(selector).hide();
		// clear projects
		selector = "#user_project__" + i;
		$(selector).html("");
		// clear percent value
		selector = "#proposed__project_percent__" + i;
		$(selector).val("");
	}
	function add_customer() {
		// need to account for differences between this and creating a staff charge or usage event record
		var failure_dialog = ajax_failure_callback("Cannot add new entry", "The web browser was not able to communicate with the server.");
		ajax_get("{% url 'contest_transaction_entry' %}", { "entry_number": current_entry_number, "cost_per_sample_run":{% if usage_event is not None %}{% if usage_event.cost_per_sample_run %}1{% else %}0{% endif %}{% else %}0{% endif %} }, add_entry_success_callback, failure_dialog);
		function add_entry_success_callback(response, status, xml_http_request)
		{
			$("#customer_project_entries tr:last").before(response);
			var identifier = "newentry_" + current_entry_number;
			enable_autocompletion(identifier);
			current_entry_number++;

			{% if usage_event is not None %}
				{% if not usage_event.cost_per_sample_run %}
			// since a new customer is joining, set all project percentages to blank
			s = "input[name*='proposed__project_percent__']";
			$(s).each(function() {
				$(this).val("");
			});
				{% endif %}
			{% else %}
			s = "input[name*='proposed__project_percent__']";
			$(s).each(function() {
				$(this).val("");
			});
			{% endif %}
		}
	}
	function enable_autocompletion(i)
	{
		var selector = "#proposed__chosen_user__" + i;
		$(selector).autocomplete('user', on_autocomplete_selection, {{ users|json_search_base }});
	}
	function on_autocomplete_selection(jquery_event, search_selection, dataset_name)
	{
		$(this).typeahead('val', search_selection.id).hide();
		var row = $(this).data('row');
		var button_id = "#button__chosen_user__" + row;
		$(button_id).val(search_selection.name).show();
		if(dataset_name == "user")
			fetch_projects(row, search_selection.id);
	}
	function fetch_projects(row, user_id)
	{
		var parameters =
		{
			"source_template": "contest_transaction",
			"user_id": user_id,
			"entry_number": row,
		};
		var target_element = "#user_project__" + row;
		var url = "{% url 'get_projects' %}?" + jQuery.param(parameters);
		var report_error = ajax_complete_callback("Could not fetch projects for user", "There was a problem obtaining the list of projects for the user.");
		$(target_element).load(url, undefined, function(responseTxt, statusTxt, xhr) {
			if(statusTxt != "success") {
				ajax_complete_callback("Could not fetch projects for user", "There was a problem obtaining the list of projects for the user.");
			} else {
				// rename newly created project list
				var s = "#chosen_project__" + row;
				var n = "proposed__chosen_project__" + row;
				$(s).attr("name", n);
				$(s).attr("id", n);
			}
		});
	}
	function on_load()
	{
		$("#other_reason").hide();

		{% if usage_event is not None %}
			{% for u in uep %}
		enable_autocompletion({{ u.id }});
			{% endfor %}
		{% endif %}
		{% if staff_charge is not None %}
			{% for s in scp %}
		enable_autocompletion({{ s.id }});
			{% endfor %}
		{% endif %}
		{% if area_access_record is not None %}
			{% for a in aarp %}
		enable_autocompletion({{ a.id }});
			{% endfor %}
		{% endif %}
		{% if consumable_withdraw is not None %}
		enable_autocompletion({{ consumable_withdraw.id }});
		{% endif %}

		$("#add_customer_link").bind("click", add_customer);
	}
	$(on_load);
	</script>
{% endblock %}
