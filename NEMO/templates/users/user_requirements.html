{% extends 'base.html' %}
{% load custom_tags_and_filters %}
{% block title %}Your Requirements{% endblock %}
{% block extrahead %}
	{% load static %}
<style>
	/* Neutral, colorless tiles */
	.panel.panel-default {
		box-shadow: none;
		border-color: #ddd;
	}

	.panel-heading {
		background-color: #f9f9f9;
	}
	/* Optional spacing */
	.core-group + .core-group {
		margin-top: 10px;
	}
	/* Keep your existing styles in case they are used elsewhere */
	button[aria-expanded="true"] .toggle-icon::before {
		content: "-";
	}

	button[aria-expanded="false"] .toggle-icon::before {
		content: "+";
	}

	button .toggle-icon::before {
		font-weight: 700;
		font-size: 1.1em;
		line-height: 1;
	}
</style>
{% endblock %}
{% block content %}

{% if post_data %}
	<table class="table table-bordered">
		<thead>
			<tr>
				<th>Parameter</th>
				<th>Value</th>
			</tr>
		</thead>
		<tbody>
		{% for key, value in post_data %}
			<tr>
				<td>{{ key }}</td>
				<td>{{ value }}</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
{% else %}
	<div class="alert alert-info">No POST data submitted.</div>
{% endif %}


<h2>Your Requirements</h2>

{% if request.GET.first == '1' %}
<div class="alert alert-info" role="alert">
	Welcome to LEO! We've set up your initial requirements. Please review them below.  You can also find information on how to get started in the Things To Do section.
</div>
{% endif %}

{# GROUPED VIEW (if provided by the view) #}
{% if grouped %}
<div class="container-fluid">
	{% for group_name, data in grouped.items %}
	<div class="panel panel-default core-group">
		<div class="panel-heading">
			<div class="row">
				<div class="col-xs-10">
					<strong>{{ group_name }}</strong>
					<span class="text-muted">({{ data.requirements|length }} requirement{{ data.requirements|length|pluralize }})</span>
				</div>
				<div class="col-xs-2 text-right">
					<button type="button"
							class="group-toggle btn btn-link"
							data-toggle="collapse"
							data-target="#group-{{ forloop.counter }}"
							aria-controls="group-{{ forloop.counter }}"
							aria-expanded="{% if data.all_completed %}false{% else %}true{% endif %}">
						<span class="glyphicon {% if data.all_completed %}glyphicon-chevron-down{% else %}glyphicon-chevron-up{% endif %}" aria-hidden="true"></span>
						<span class="sr-only">Toggle {{ group_name }} requirements</span>
					</button>
				</div>
			</div>
		</div>
		<div id="group-{{ forloop.counter }}" class="panel-collapse collapse core-collapse {% if not data.all_completed %}in{% endif %}">
			<div class="panel-body" style="padding:10px 15px;">
				<div class="table-responsive">
					<table class="table">
						<thead>
							<tr>
								<th></th>
								<th>Requirement</th>
								<th>Resources</th>
								<th>Estimated Time to Complete</th>
								<th>Date Completed</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{% for req in data.requirements %}
							<tr>
								<td><span class="{{ req.status }}"></span></td>
								<td><span title="{{ req.description }}">{{ req.name }}</span></td>
								<td>
									{% if req.resource_link %}
									<a href="{{ req.resource_link }}" target="_blank">{{ req.resource_link }}</a>
									{% else %}
									N/A
									{% endif %}
								</td>
								<td>{{ req.expected_completion_time }}</td>
								<td>{{ req.completed_on|date:"m/d/Y"|default:"" }}</td>
								<td>
									{% if not req.automated_update and req.status_value != 'completed' %}
									<form method="post" action="{% url 'complete_user_requirement' %}">
										{% csrf_token %}
										<input type="hidden" name="requirement_id" value="{{ req.id }}">
										<button type="submit" class="btn btn-primary btn-sm">Mark Completed</button>
									</form>
									{% endif %}
									{% if req.automated_update and req.status_value != 'completed' %}
									<span class="text-muted">Automated Update</span>
									{% endif %}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
</div>

{# FALLBACK: ORIGINAL FLAT TABLE (when grouped is not provided) #}
{% else %}
<table class="table">
	<thead>
		<tr>
			<th></th>
			<th>Requirement</th>
			<th>Resources</th>
			<th>Estimated Time to Complete</th>
			<th>Date Completed</th>
			<th></th>
		</tr>
	</thead>
	<tbody>
		{% for req in requirements %}
		<tr>
			<td><span class="{{ req.status }}"></span></td>
			<td><span title="{{ req.description }}">{{ req.name }}</span></td>
			<td>
				{% if req.resource_link %}
				<a href="{{ req.resource_link }}" target="_blank">{{ req.resource_link }}</a>
				{% else %}
				N/A
				{% endif %}
			</td>
			<td>{{ req.expected_completion_time }}</td>
			<td>{{ req.completed_on|date:"m/d/Y"|default:"" }}</td>
			<td>
				{% if not req.automated_update and req.status_value != 'completed' %}
				<form method="post" action="{% url 'complete_user_requirement' %}">
					{% csrf_token %}
					<input type="hidden" name="requirement_id" value="{{ req.id }}">
					<button type="submit" class="btn btn-primary btn-sm">Mark Completed</button>
				</form>
				{% endif %}
			</td>
		</tr>
		{% empty %}
		<tr>
			<td colspan="6">
				<div class="alert alert-info" role="alert">No requirements found.</div>
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
{% endif %}
<br/><br/>

<h2>Services</h2>

<div class="container-fluid">
{% if request.GET.first == '1' %}
<div class="alert alert-info" role="alert">
	Do you want to become and on site user? <button class="btn btn-success">Yes</button> <button class="btn btn-danger">No</button>
</div>
{% else %}
<div class="alert alert-info" role="alert">
	<button class="btn btn-success" id="btn_add_service">Add a service</button>
</div>
{% endif %}

<div class="panel panel-default core-group" id="pnl_choose_core" style="display:none;">
	<div class="panel-heading">
		<div class="row">
			<div class="col-xs-10">
				<strong><span id="pnl_title">Choose a core</span></strong>
			</div>
			<div class="col-xs-2 text-right">
					
			</div>
		</div>
	</div>
	<div id="group-temp" class="panel-collapse collapse core-collapse">
		<div class="panel-body" style="padding:10px 15px;">
			<div>
				<select class="form-control" id="choose_core">
					<option value="">-- Choose a core --</option>
					<option value="1">Materials Characterization Lab (MCL)</option>
					<option value="2">Nanofab</option>
					<option value="4">2DCC</option>
				</select>
			</div>
		</div>
	</div>
</div>

<div class="panel panel-default core-group" id="pnl_template" style="display:none;">
	<div class="panel-heading">
		<div class="row">
			<div class="col-xs-10">
				<strong><span id="pnl_title"></span></strong>
			</div>
			<div class="col-xs-2 text-right">
					
			</div>
		</div>
	</div>
	<div id="group-temp" class="panel-collapse collapse core-collapse">
		<div class="panel-body" style="padding:10px 15px;">
				
		</div>
	</div>
</div>

<div class="panel panel-default core-group" id="mcl_template" style="display:none;">
	<div class="panel-heading">
		<div class="row">
			<div class="col-xs-10">
				<strong><span id="pnl_title">Materials Characterization Lab Request</span></strong>
			</div>
			<div class="col-xs-2 text-right">
				<button type="button" class="group-toggle btn btn-link" data-toggle="collapse" data-target="#group-mcl" aria-controls="group-mcl" aria-expanded="true">
					<span class="glyphicon glyphicon-chevron-up" aria-hidden="false"></span>
					<span class="sr-only">Toggle MCL Requests</span>
				</button>
			</div>
		</div>
	</div>
	<div id="group-mcl" class="panel-collapse collapse core-collapse in">
		<div class="panel-body" style="padding:10px 15px;">
			<form method="post">
			{% csrf_token %}
			<table class="table" id="mcl_request_table">
				<thead>
					<tr>
						<th>Service</th>
						<th>Project</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>
					<tr class="mcl-row">
						<td>
							<select name="service_select" class="form-control">
								<option value="">Please select an option</option>
								{% for opt in mcl_services %}
								<option value="{{ opt.id }}">{{ opt.name }}</option>
								{% endfor %}
							</select>
						</td>
						<td>
							{% if user_projects is not None %}
							<select name="project_select" class="form-control">
								<option value="">Please select an option</option>
								{% for p in user_projects %}
								<option value="{{ p.id }}">{{ p }} [PI: {{ p.owner.first_name }} {{ p.owner.last_name }} ({{ p.owner.username }})]</option>
								{% endfor %}
							</select>
							{% else %}
							No project available
							{% endif %}
						</td>
						<td>
							<textarea class="form-control" rows="3" cols="20" name="description"></textarea>
						</td>
					</tr>
					<tr>
						<td colspan="3">
							<button class="btn btn-success" id="btn_mcl_add_service">Add a service</button>
							<input type="submit" class="btn btn-success" value="Submit" id="btn_mcl_submit" />
						</td>
					</tr>
				</tbody>
			</table>
			</form>
		</div>
	</div>
</div>

<div class="panel panel-default core-group" id="nano_template" style="display:none;">
	<div class="panel-heading">
		<div class="row">
			<div class="col-xs-10">
				<strong><span id="pnl_title">Nanofab Request</span></strong>
			</div>
			<div class="col-xs-2 text-right">
				<button type="button" class="group-toggle btn btn-link" data-toggle="collapse" data-target="#group-nano" aria-controls="group-nano" aria-expanded="true">
					<span class="glyphicon glyphicon-chevron-up" aria-hidden="false"></span>
					<span class="sr-only">Toggle Nano Requests</span>
				</button>
			</div>
		</div>
	</div>
	<div id="group-nano" class="panel-collapse collapse core-collapse in">
		<div class="panel-body" style="padding:10px 15px;">
			<form method="post">
			{% csrf_token %}
			<table class="table" id="nano_request_table">
				<thead>
					<tr>
						<th>Service</th>
						<th>Project</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>
					<tr class="nano-row">
						<td>
							<select name="service_select" class="form-control">
								<option value="">Please select an option</option>
								{% for opt in nano_services %}
								<option value="{{ opt.id }}">{{ opt.name }}</option>
								{% endfor %}
							</select>
						</td>
						<td>
							{% if user_projects is not None %}
							<select name="project_select" class="form-control">
								<option value="">Please select an option</option>
								{% for p in user_projects %}
								<option value="{{ p.id }}">{{ p }} [PI: {{ p.owner.first_name }} {{ p.owner.last_name }} ({{ p.owner.username }})]</option>
								{% endfor %}
							</select>
							{% else %}
							No project available
							{% endif %}
						</td>
						<td>
							<textarea class="form-control" rows="3" cols="20" name="description"></textarea>
						</td>
					</tr>
					<tr>
						<td colspan="3">
							<button class="btn btn-success" id="btn_nano_add_service">Add a service</button>
							<input type="submit" class="btn btn-success" value="Submit" id="btn_nano_submit" />
						</td>
					</tr>
				</tbody>
			</table>
			</form>
		</div>
	</div>
</div>

</div>
<script>
	(function () {
		var collapses = document.querySelectorAll('.core-collapse');
		Array.prototype.forEach.call(collapses, function (c) {
			c.addEventListener('show.bs.collapse', function () {
				var heading = c.previousElementSibling;
				if (!heading) return;
				var icon = heading.querySelector('.group-toggle .glyphicon');
				if (!icon) return;
				icon.classList.remove('glyphicon-chevron-down');
				icon.classList.add('glyphicon-chevron-up');
			});
			c.addEventListener('hide.bs.collapse', function () {
				var heading = c.previousElementSibling;
				if (!heading) return;
				var icon = heading.querySelector('.group-toggle .glyphicon');
				if (!icon) return;
				icon.classList.remove('glyphicon-chevron-up');
				icon.classList.add('glyphicon-chevron-down');
			});
		});
	})();
</script>
<script>
	(function () {
		var $ = window.jQuery;
		if (!$) return;
		if (!$.fn || !$.fn.collapse) return;
		$('.core-collapse').collapse({ toggle: false });
		$(document).on('click', '.group-toggle', function (e) {
			e.preventDefault();
			var target = this.getAttribute('data-target');
			if (!target || target === '#') return;
			var $panel = $(target);
			if ($panel.length) { $panel.collapse('toggle'); }
		});
		$('.core-collapse')
			.on('show.bs.collapse', function () {
				var $icon = $(this).prev('.panel-heading').find('.group-toggle .glyphicon');
				$icon.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
			})
			.on('hide.bs.collapse', function () {
				var $icon = $(this).prev('.panel-heading').find('.group-toggle .glyphicon');
				$icon.removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
			});

		$(document).on('click', '#btn_add_service', function (e) {
			e.preventDefault();
			var $panel = $('#pnl_choose_core .core-collapse');
			if ($panel.length) {
				$panel.collapse('show');
			}
			$('#pnl_choose_core').show();
			$('#btn_add_service').parent().hide();
		});
		$(document).on('change', '#choose_core', function (e) {
			e.preventDefault();
			var $panel = $('#pnl_choose_core');
			$panel.hide();

			var coreId = this.value;
			if (!coreId) return;

			// load the template for the selected core
			if (coreId == '1') {
				$("#mcl_template").show();
				$('#group-mcl').collapse('show');
				$("#btn_mcl_submit").on('click', function () {
					$("#mcl_template").hide();					
					$('#btn_add_service').parent().show();
				});
			}

			if (coreId == '2') {
				$("#nano_template").show();
				$('#group-nano').collapse('show');
				$("#btn_nano_submit").on('click', function () {
					$("#nano_template").hide();					
					$('#btn_add_service').parent().show();
				});
			}
		});

		$(document).on('click', '#btn_mcl_add_service', function (e) {
			e.preventDefault();
			var $tbody = $('#mcl_request_table tbody');
			var $templateRow = $tbody.find('tr.mcl-row').first();
			if (!$templateRow.length) return;
			var $newRow = $templateRow.clone(true, true);
			$newRow.find('select[name="service_select"]').val('');
			$newRow.find('select[name="project_select"]').val('');
			$tbody.find('tr.mcl-row').last().after($newRow);
		});

		$(document).on('click', '#btn_nano_add_service', function (e) {
			e.preventDefault();
			var $tbody = $('#nano_request_table tbody');
			var $templateRow = $tbody.find('tr.nano-row').first();
			if (!$templateRow.length) return;
			var $newRow = $templateRow.clone(true, true);
			$newRow.find('select[name="service_select"]').val('');
			$newRow.find('select[name="project_select"]').val('');
			$tbody.find('tr.nano-row').last().after($newRow);
		});
	})();
</script>
{% endblock %}