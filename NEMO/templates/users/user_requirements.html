{% extends 'base.html' %}
{% load custom_tags_and_filters %}
{% block title %}Your Requirements{% endblock %}
{% block extrahead %}
	{% load static %}
<style>
	/* Neutral, colorless tiles */
	.panel.panel-default {
		box-shadow: none;
		border-color: #ddd;
	}

	.panel-heading {
		background-color: #f9f9f9;
	}
	/* Optional spacing */
	.core-group + .core-group {
		margin-top: 10px;
	}
	/* Keep your existing styles in case they are used elsewhere */
	button[aria-expanded="true"] .toggle-icon::before {
		content: "-";
	}

	button[aria-expanded="false"] .toggle-icon::before {
		content: "+";
	}

	button .toggle-icon::before {
		font-weight: 700;
		font-size: 1.1em;
		line-height: 1;
	}

	tr.danger {
		background-color: #f2dede;
	}
</style>
{% endblock %}
{% block content %}

<h2>Your Requirements</h2>

<div class="container-fluid">
{% if request.GET.first == '1' %}
<div class="alert alert-info" role="alert">
	Welcome to LEO! We've set up your initial requirements. Please review them below.  You can also find information on how to get started in the Things To Do section.
</div>
{% endif %}

<table class="table table-striped">
	<thead>
		<tr>
			<th></th>
			<th>Requirement</th>
			<th>Status</th>
			<th>Added</th>
			<th>Completed On</th>
			<th>Resources</th>
			<th>Prerequisites</th>
			<th>Estimated Time</th>
			<th></th>
		</tr>
	</thead>
	<tbody>
	{% for req in requirements_table %}
		<tr class="requirement-row" data-req-id="{{ req.id }}" style="cursor: pointer; background-color:{% if req.status_value == 'Not Started' %}#ffcccc{% endif %}{% if req.status_value == 'Completed' %}#ccffcc{% endif %}{% if req.status_value == 'In Progress' %}#ffffcc{% endif %};">
			<td><span class="glyphicon glyphicon-plus"></span></td>
			<td>{{ req.name }}</td>
			<td>{{ req.status_value|default:"Not Started" }}</td>
			<td>{{ req.created|date:"m/d/Y"|default:"" }}</td>
			<td>{{ req.completed_on|date:"m/d/Y"|default:"" }}</td>
			<td>
				{% if req.resource_link and req.resource_link != 'NULL' %}
					<a href="{{ req.resource_link }}" target="_blank">{{ req.resource_link_name }}</a>
				{% else %}
					N/A
				{% endif %}
			</td>
			<td>{{ req.prerequisites }}</td>
			<td>{% if req.expected_completion_time %}{{ req.expected_completion_time }}{% endif %}</td>
			<td>
				{% if not req.automated_update %}
					{% if req.status_value == 'Completed' %}
						<form method="post" action="{% url 'unmark_user_requirement' %}" onsubmit="return confirm('Please confirm that you wish to mark the requirement {{ req.name }} as incomplete.  Once you make this change you will have to sign again to mark it completed.');">
							{% csrf_token %}
							<input type="hidden" name="requirement_id" value="{{ req.id }}">
							<button type="submit" class="btn btn-warning btn-sm">Unmark Completed</button>
						</form>
					{% elif req.status_value != 'Completed' %}
						<form method="post" action="{% url 'complete_user_requirement' %}" onsubmit="return prompt('Please enter your username ({{ request.user.username }}) to indicate you have completed the requirement - {{ req.name }}') == '{{ request.user.username }}';">
							{% csrf_token %}
							<input type="hidden" name="requirement_id" value="{{ req.id }}">
							<button type="submit" class="btn btn-primary btn-sm">Mark Completed</button>
						</form>
					{% endif %}
				{% endif %}
				{% if req.automated_update and req.status_value != 'Completed' %}
					<span class="text-muted">Automated Update</span>
				{% endif %}
			</td>
		</tr>
		<tr class="requirement-details-row" data-req-id="{{ req.id }}" style="display:none;">
			<td colspan="9">
				<strong>Related Service Request:</strong>
				{% if req.main_service_request %}
					<div>
						<b>{{ req.main_service_request.service_type.name }}</b>
						(Project: {{ req.main_service_request.project.name }}, Status: {{ req.main_service_request.status }})
						<br>
						Description: {{ req.main_service_request.description|default:"-" }}
					</div>
				{% else %}
					<div>No direct service request associated.</div>
				{% endif %}
				<hr>
				<strong>Other Service Requests depending on this requirement:</strong>
				<ul>
				{% for sr in req.other_service_requests %}
					<li>
						<b>{{ sr.service_type.name }}</b>
						(Project: {{ sr.project.name }}, Status: {{ sr.status }})
						<br>
						Description: {{ sr.description|default:"-" }}
					</li>
				{% empty %}
					<li>None</li>
				{% endfor %}
				</ul>
			</td>
		</tr>
	{% endfor %}
	</tbody>
</table>

</div>
<script>
(function () {
	var $ = window.jQuery;
	if (!$) return;

	// Use jQuery's event system for Bootstrap collapse events
	$('.core-collapse')
		.on('show.bs.collapse', function () {
			var $icon = $(this).prev('.panel-heading').find('.group-toggle .glyphicon');
			$icon.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
		})
		.on('hide.bs.collapse', function () {
			var $icon = $(this).prev('.panel-heading').find('.group-toggle .glyphicon');
			$icon.removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
		});

	$(document).on('click', '.requirement-row', function () {
		var reqId = $(this).data('req-id');
		var $detailsRow = $('.requirement-details-row[data-req-id="' + reqId + '"]');
		var $icon = $(this).find('.glyphicon');
		$detailsRow.toggle();
		$icon.toggleClass('glyphicon-plus glyphicon-minus');
	});
})();
</script>

{% endblock %}